- name: gnome_extensions script
  block:
    - name: Check if extension already exists
      ansible.builtin.stat:
        path: "{{ gnome_extension_dir }}/{{ item.name }}"
      register: extension_status
      loop: "{{ gnome_extensions }}"

    - name: Install and enable GNOME extensions
      ansible.builtin.shell: |
        roles/install-gnome-extensions/install-gnome-extensions.sh --enable {{ item.item.id }}
      loop: "{{ extension_status.results }}"
      when: not item.stat.exists
      loop_control:
        label: "{{ item.item.name }}"

- name: gnome_extensions_zip archive
  block:
    - name: Check if extension already exists
      ansible.builtin.stat:
        path: "{{ gnome_extension_dir }}/{{ item.name }}"
      register: extension_zip_status
      loop: "{{ gnome_extensions_zip }}"

    - name: Create temp directory if it does not exist
      ansible.builtin.file:
        path: "{{ gnome_extension_dir }}/temp"
        state: directory
      loop: "{{ extension_zip_status.results }}"
      when: not item.stat.exists
      loop_control:
        label: "{{ item.item.name }}"


    - name: Download file with custom HTTP headers
      ansible.builtin.get_url:
        url: "{{ item.item.url }}"
        dest: "{{ gnome_extension_dir }}/temp/{{ item.item.name }}.zip"
      loop: "{{ extension_zip_status.results }}"
      when: not item.stat.exists
      loop_control:
        label: "{{ item.item.name }}"

    - name: Enable GNOME extensions
      ansible.builtin.shell: |
        gnome-extensions install -f {{ gnome_extension_dir }}/temp/{{ item.item.name }}.zip
      loop: "{{ extension_zip_status.results }}"
      when: not item.stat.exists
      loop_control:
        label: "{{ item.item.name }}"

    - name: Copy gesture-extension custom config #https://github.com/harshadgavali/gnome-gesture-improvements/issues/206#issuecomment-2026336600
      block:
        - name: Ensure folder exist
          ansible.builtin.file:
            path: "{{ gnome_extension_dir }}/gestureImprovements@gestures/src"
            state: directory

        - name: Copy file
          ansible.posix.synchronize:
            src: "configs/gesture-extension/snapWindow.js"
            dest: "{{ gnome_extension_dir }}/gestureImprovements@gestures/src/snapWindow.js"
